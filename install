#!/bin/bash
set -e

#######################################
#	PiHole + OpenVPN + nftables on arch ARMv7
#	Assumes a wired connection on $INTERFACE
#
#	Arguments:
#		None
#	Returns:
#		1 upon error
#		0 otherwise
#######################################
function main() {
	local readonly USAGE="Usage: install"

	if [[ "${#}" -ne 0 ]]; then
		err "Error: no argument required"
		err "${USAGE}"
		return 1
	fi

	if [ "${EUID}" -ne 0 ]; then
		err "Please run as root"
		return 2
	fi

	if [[ ! -f .env ]]; then
		err "Could not find .env file"
		return 3
	fi

	# Load .env
	set -o allexport && source .env && set +o allexport

	# Make sure we are ready
	cat .env
	warn	"\nBefore continuing, please make sure that:\n" \
		"\t- The server is set up with a static local IP (${SERVER_LAN_IP});\n" \
		"\t- The variables in .env are correct\n"

	# Change default passwords
	echo -e "\nNew password for root:"
	passwd root
	echo "New passord for alarm:"
	passwd alarm
	useradd -m -G wheel -s /bin/bash "${MY_USER}"
	echo "New password for ${MY_USER}:"
	passwd "${MY_USER}"

	# Set hostname
	echo "${SERVER_HOSTNAME}" > /etc/hostname
	echo -e "127.0.0.1\t\tlocalhost" > /etc/hosts
	echo -e "${SERVER_LAN_IP}\t\t${SERVER_HOSTNAME} pi.hole" >> /etc/hosts

	# Get keys, update, install base packages
	pacman-key --init
	pacman-key --populate archlinuxarm
	pacman -Syu
	pacman -S --needed sudo base-devel git nftables cargo vim

	# Configure sudo
	warn "Allow members of wheel group to run sudo"
	visudo

	# Setup services
	install_from_aur paru
	install_nftables
	setup_sshd
	install_openvpn
	pacman -S --needed --asdeps go glibc && install_from_aur cloudflared
	install_pihole

	# Done - Check the following files

	warn "Check /etc/pihole/setupVars.conf"
	vim /etc/pihole/setupVars.conf

	warn "Check /etc/dnsmasq.d/01-pihole.conf"
	vim /etc/dnsmasq.d/01-pihole.conf

	echo "Done. Please reboot"

	return 0
}

#######################################
#       Install from AUR              #
#######################################
function install_from_aur() {
	[[ "${#}" -ne 1 ]] && return 1

	su "${MY_USER}" -c "mkdir -p /home/${MY_USER}/.cache/paru/clone/"
	su "${MY_USER}" -c "git clone \"https://aur.archlinux.org/${1}.git/\" \"/home/${MY_USER}/.cache/paru/clone/${1}/\""
	su "${MY_USER}" -c "cd \"/home/${MY_USER}/.cache/paru/clone/${1}/\" && makepkg --noconfirm -s"

	pacman --noconfirm -U "$(ls /home/${MY_USER}/.cache/paru/clone/${1}/*.pkg.tar.xz)"

	return 0
}

#######################################
#       Install nftables              #
#######################################
function install_nftables() {
	# Backup
	[[ -f /etc/nftables.conf ]] && mv /etc/nftables.conf /etc/nftables.conf.bak
	
	# Set new config
	cp /root/etc/nftables.conf /etc/nftables.conf
	# sed
	vim /etc/nftables.conf

	systemctl enable nftables

	return 0
}

#######################################
#       Configure sshd                #
#######################################
function setup_sshd() {
	mv /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
	cp /root/etc/ssh/sshd_config /etc/ssh/sshd_config
	vim /etc/ssh/sshd_config

	# Add personal pubkey
	su "${MY_USER}" -c "mkdir -p ~/.ssh && echo -e \"${MY_PUBKEY}\" >> ~/.ssh/authorized_keys"

	return 0
}

#######################################
#       Install OpenVPN               #
#######################################
function install_openvpn() {
	pacman -S openvpn easy-rsa

	# Define env
	export EASYRSA=/etc/easy-rsa/
	export EASYRSA_VARS_FILE=/etc/easy-rsa/vars

	# Set up Easy-rsa vars
	mv "${EASYRSA_VARS_FILE}" "${EASYRSA_VARS_FILE}.bak"
	echo "set_var EASYRSA_ALGO ec" > "${EASYRSA_VARS_FILE}"
	echo "set_var EASYRSA_CURVE secp521r1" >> "${EASYRSA_VARS_FILE}"
	echo "set_var EASYRSA_DIGEST \"sha512\"" >> "${EASYRSA_VARS_FILE}"
	echo "set_var EASYRSA_NS_SUPPORT \"no\"" >> "${EASYRSA_VARS_FILE}"
	vim "${EASYRSA_VARS_FILE}"

	# Set up CA, keys and crt
	openvpn --genkey secret /etc/openvpn/server/ta.key

	cd "${EASYRSA}"
	easyrsa init-pki
	easyrsa build-ca
	easyrsa gen-req "${SERVER_HOSTNAME}" nopass
	easyrsa sign-req server "${SERVER_HOSTNAME}"
	easyrsa gen-crl
	cd /root/

	# Copy keys and cert to /etc/openvpn/
	cp	/etc/easy-rsa/pki/ca.crt \
		"/etc/easy-rsa/pki/private/${SERVER_HOSTNAME}.key" \
		"/etc/easy-rsa/pki/issued/${SERVER_HOSTNAME}.crt" \
		/etc/easy-rsa/pki/crl.pem \
		/etc/openvpn/server/
	
	# Fetch openvpn config
	cp /root/etc/openvpn/server/server.conf "/etc/openvpn/server/${SERVER_HOSTNAME}.conf"
	sed -i "s/myservername/${SERVER_HOSTNAME}/g" "/etc/openvpn/server/${SERVER_HOSTNAME}.conf"
	sed -i "s/mylan/${LAN}/g" "/etc/openvpn/server/${SERVER_HOSTNAME}.conf"
	sed -i "s/mypiip/${SERVER_LAN_IP}/g" "/etc/openvpn/server/${SERVER_HOSTNAME}.conf"
	vim "/etc/openvpn/server/${SERVER_HOSTNAME}.conf"

	mkdir -p /etc/dnsmasq.d/
	echo "interface=tun0" > /etc/dnsmasq.d/00-openvpn.conf

	cp /root/etc/openvpn/new_client /etc/openvpn/
	sed -i "s/my_remote_ip/${SERVER_WAN_IP}/g" /etc/openvpn/new_client

	sudo chown -R openvpn.network /etc/openvpn/client /etc/openvpn/server

	systemctl enable "openvpn-server@${SERVER_HOSTNAME}"

	return 0
}

#######################################
#       Install Pihole               #
#######################################
function install_pihole() {
	pacman -S --needed --asdeps php7 php7-cgi php7-fpm php7-sqlite lighttpd \
		bc logrotate bind-tools lsof cmake libidn
	install_from_aur pi-hole-ftl
	install_from_aur pi-hole-server

	# Disable systemd-resolved
	#sed -i '/DNSStubListener=yes/s/^#//g' /etc/systemd/resolved.conf
	#sed -i 's/DNSStubListener=yes/DNSStubListener=no/g' /etc/systemd/resolved.conf
	systemctl disable --now systemd-resolved
	rm /etc/resolv.conf
	echo "nameserver 127.0.0.1" > /etc/resolv.conf

	# Cloudflared config
	[[ -f /etc/cloudflared/config.yml ]] && mv /etc/cloudflared/config.yml /etc/cloudflared/config.yml.bak
	cp /root/etc/cloudflared/config.yml /etc/cloudflared/config.yml

	# Set up Lighthtpd
	cp /usr/share/pihole/configs/lighttpd.example.conf /etc/lighttpd/lighttpd.conf
	sed -i 's/\/usr\/bin\/php-cgi/\/usr\/bin\/php-cgi7/g' /etc/lighttpd/lighttpd.conf
	
	# Set up php7
	sed -i '/extension=pdo_sqlite/s/^;//g' /etc/php7/php.ini
	sed -i '/extension=sockets/s/^;//g' /etc/php7/php.ini
	sed -i '/extension=sqlite3/s/^;//g' /etc/php7/php.ini

	# Update DNS in /etc/systemd/network/INTERFACE.network
	warn "Make DNS 127.0.0.1"
	sed -i "s/1.1.1.1/${SERVER_LAN_IP}/g" "/etc/systemd/network/${INTERFACE}.network"
	sed -i "s/1.0.0.1/${SERVER_LAN_IP}/g" "/etc/systemd/network/${INTERFACE}.network"
	vim "/etc/systemd/network/${INTERFACE}.network"

	# Pihole config
	mv /etc/pihole/setupVars.conf /etc/pihole/setupVars.conf.bak
	cp /root/etc/pihole/setupVars.conf /etc/pihole/setupVars.conf
	sed -i "s/SERVER_LAN_IP/${SERVER_LAN_IP}/g" /etc/pihole/setupVars.conf
	sed -i "s/SERVER_HOSTNAME/${SERVER_HOSTNAME}/g" /etc/pihole/setupVars.conf
	sed -i "s/LAN_GATEWAY/${LAN_GATEWAY}/g" /etc/pihole/setupVars.conf
	sed -i "s/IP_START/$(echo ${LAN} | cut -d "." -f -3  | sort -u)/g" /etc/pihole/setupVars.conf
	vim /etc/pihole/setupVars.conf

	# Start server
	systemctl enable lighttpd
	systemctl enable cloudflared pihole-FTL

	return 0
}

#######################################
#       Div helpers
#######################################

function warn() {
	echo -e "${*}"
	echo -n "Press any key to continue or ^C to abort."
	read -s -n 1 key
}

# Print to stderr (from Google)
function err() {
        echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: ${*}" >&2
}

# Functions to run with su
export -f install_from_aur

main "${@}"; exit
