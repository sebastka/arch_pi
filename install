#!/bin/sh
set -e      # Abort upon error
set -u      # Abort upon udefined variable
#set -x      # Print every command

readonly path="$(dirname `readlink -f "$0"`)"

#######################################
#    Arch ARMv7 on RPI4
#    Assumes a wired connection on $CONFIG_LAN_INTERFACE
#
#    Arguments:
#        None!
#    Returns:
#        1 upon error
#        0 otherwise
#######################################
main() {
    readonly USAGE="Usage: ./install"
    [ "$#" -eq 0 ] || { err "Error: 0 argument expected, $# received"; err "$USAGE"; return 1; }
    [ -f "$path/.env" ] || { err 'Error: Please configure .env'; return 3; }

    load_env
    init
    install_base
    install_wireguard
    install_docker

    printf '\nDone. Please reboot\n'
}

# Load env
load_env() {
    set -a; . "$path/.env"; set +a
}

init() {
    # If sudo is installed, init() has already been run (as root): continue
    if command -v sudo >/dev/null; then
        [ "$(id -u)" -ne 0 ] || { err 'Error: Please DO NOT run as root'; return 2; }
        return 0
    else
        [ "$(id -u)" -eq 0 ] || { err 'Error: Please run as root'; return 2; }
    fi

    printf '\nInitialize...\n'

    # Locale
    timedatectl set-ntp true
    locale-gen

    # Pacman
    pacman-key --init
    pacman-key --populate archlinuxarm
    pacman -Syu --noconfirm

    # Sudo
    pacman -S sudo
    sed -i '/%wheel ALL=(ALL:ALL) ALL/s/^# //' /etc/sudoers

    printf '\nRun again as unprivileged user\n'
    exit 0
}

# Install base system
install_base() {
    printf '\nInstalling base system...\n'

    # Install basic packages
    sudo pacman -S --noconfirm --needed base-devel btrfs-progs man-db man-pages dnsutils git vim wget htop dhcp

    # Install extra packages
    sudo pacman -S --noconfirm --needed $CONFIG_SYSTEM_EXTRA_PACKAGES
    aur_install $CONFIG_SYSTEM_EXTRA_PACKAGES_AUR
}

install_wireguard() {
	## Using systemd-networkd's native WireGuard support
	## https://elou.world/en/tutorial/wireguard
	## https://wiki.archlinux.org/title/WireGuard

	sudo pacman -S --noconfirm --needed wireguard-tools qrencode

    # IP forwarding
    printf 'net.ipv4.ip_forward = 1\nnet.ipv4.conf.all.forwarding = 1\nnet.ipv6.conf.all.forwarding = 1\nnet.ipv4.conf.all.src_valid_mark = 1\n' \
        | sudo tee /etc/sysctl.d/30-ipforward.conf >/dev/null

    # Create "server" peer dir
    sudo mkdir -p "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/server" "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients"

    # Gen "server" peer priv/pub keys
	wg genkey \
        | sudo tee "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/server/$CONFIG_SERVER_HOSTNAME.private.key" \
        | wg pubkey \
        | sudo tee "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/server/$CONFIG_SERVER_HOSTNAME.public.key" >/dev/null

    # "Server" peer variables
    srv_addr="$(echo "$CONFIG_WIREGUARD_SUBNET" | sed 's/.\//1\//')"
    srv_pub_key="$(sudo cat "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/server/$CONFIG_SERVER_HOSTNAME.public.key")"

    # Create "server" peer conf
    printf '[Interface]\nAddress = %s\nListenPort = 51820\nPostUp = wg set %%i private-key /etc/wireguard/%s/server/%s.private.key\n\nPostUp = iptables -A INPUT -i %s -p udp --dport 51820 -m state --state NEW -j ACCEPT\nPostUp = iptables -A FORWARD -i %%i -j ACCEPT\nPostUp = iptables -A FORWARD -o %%i -j ACCEPT\nPostUp = iptables -t nat -A POSTROUTING -o %s -j MASQUERADE\n\nPostDown = iptables -D INPUT -i %s -p udp --dport 51820 -m state --state NEW -j ACCEPT\nPostDown = iptables -D FORWARD -i %%i -j ACCEPT\nPostDown = iptables -D FORWARD -o %%i -j ACCEPT\nPostDown = iptables -t nat -D POSTROUTING -o %s -j MASQUERADE\n\n' \
        "$srv_addr" "$CONFIG_SERVER_HOSTNAME" "$CONFIG_SERVER_HOSTNAME" "$CONFIG_LAN_INTERFACE" "$CONFIG_LAN_INTERFACE" "$CONFIG_LAN_INTERFACE" "$CONFIG_LAN_INTERFACE" \
        | sudo tee /etc/wireguard/wg0.conf >/dev/null

    # Create "client" peers
    i=1
    for peer_name in $CONFIG_WIREGUAR_PEERS; do
        i=$((i+1))

        # Gen priv/pub keys + preshared key
        wg genkey \
            | sudo tee "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.private.key" \
            | wg pubkey \
            | sudo tee "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.public.key" >/dev/null
        wg genpsk | sudo tee "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name-$CONFIG_SERVER_HOSTNAME.psk" >/dev/null

        # "Client" peer variables
        client_ip="$(echo "$CONFIG_WIREGUARD_SUBNET" | cut -d'.' -f1-3).$i"
        client_pub_key="$(sudo cat "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.public.key")"
        client_priv_key="$(sudo cat "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.private.key")"
        psk="$(sudo cat "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name-$CONFIG_SERVER_HOSTNAME.psk")"

        # Add "client" peer to "server" peer config

        printf '[Peer]\n# %s\nPublicKey = %s\nPresharedKey = %s\nAllowedIPs = %s/32\n\n' \
            "$peer_name" "$client_pub_key" "$psk" "$client_ip" \
            | sudo tee -a /etc/wireguard/wg0.conf >/dev/null

        # Create peer "client" config

        printf '[Interface]\nAddress = %s/32\nListenPort = 51820\nPrivateKey = %s\nDNS=%s\n\n' \
            "$client_ip" "$client_priv_key" "$CONFIG_LAN_IP" \
            | sudo tee "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.conf" >/dev/null

        printf '[Peer]\n# %s\nPublicKey = %s\nPresharedKey = %s\nEndpoint = %s:%s\nAllowedIPs = %s\n' \
            "$CONFIG_SERVER_HOSTNAME" "$srv_pub_key" "$psk" "$CONFIG_SERVER_REMOTE_URL" "$CONFIG_WIREGUARD_EXTERNAL_PORT" "$CONFIG_WIREGUARD_ROUTES" \
            | sudo tee -a "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.conf" >/dev/null

        # Generate QR code for config
        sudo qrencode -t ansiutf8 \
            -r "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.conf" \
            -o "/etc/wireguard/$CONFIG_SERVER_HOSTNAME/clients/$peer_name.conf.png"
    done

    # Update permissions
    sudo find /etc/wireguard -type d -exec chmod 700 {} \;
    sudo find /etc/wireguard -type f -exec chmod 600 {} \;
    sudo chmod ugo+rx /etc/wireguard
    sudo chmod ugo+r /etc/wireguard/wg0.conf

    # Enable service
    sudo systemctl enable "wg-quick@wg0"
}

# Setup Docker
install_docker() {
    printf '\nSetting up Docker...\n'

    sudo pacman -S --noconfirm docker docker-compose
    sudo systemctl enable docker # Reboot is needed before it can start

    # Some containers require an initial setup
    find /home/"$CONFIG_USER_NAME"/docker/*/prepare.sh | while read f; do
        . "$f"
    done

    # Terminate
    printf '\nAfter reboot, run "~/docker/update x" to get the x container started.\n'
}

# Install from AUR
aur_install() {
    mkdir /tmp/aur

    for package in $@; do
        git clone "https://aur.archlinux.org/$package.git/" "/tmp/aur/$package"
        cd "/tmp/aur/$package"
        makepkg --noconfirm -s

        sudo pacman --noconfirm -U "/tmp/aur/$package"/*.pkg.tar.xz
    done

    rm -rf "/tmp/aur"
}

#######################################
#   Print error message to stderr
#   https://google.github.io/styleguide/shellguide.html
#######################################
err() { echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $*" >&2; }

main "$@"; exit
